AWSTemplateFormatVersion: 2010-09-09

Description: Cria um bucket privado

Parameters:

  BucketName:
    Type: String
    Default: lambda-src
  
  VersioningConfiguration:
    Type: String
    Default:  Suspended
  
  KMSMasterKeyId:
    Type: String

  Owner:
    Type: String
    Default: tg

Resources:

  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: [ "${AWS::AccountId}-${BucketName}", BucketName: !Ref BucketName ]
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
      # BucketEncryption:
      #   ServerSideEncryptionConfiguration:
      #     - ServerSideEncryptionByDefault:
      #       KMSMasterKeyId: !Ref KMSMasterKeyId
      #       SSEAlgorithm: aws:kms
      VersioningConfiguration:
        Status: !Ref VersioningConfiguration
      Tags:
        - Key: Owner
          Value: !Ref Owner
  
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Bucket
      PolicyDocument:
        Statement:
          - Sid: AllowSSLRequestOnly
            Action:
              - s3:*
            Effect: Deny
            Resource:
              Fn::Join: [ '', [ "arn:aws:s3:::", !Ref Bucket, "/*" ] ]
            Condition:
              Bool:
                "aws:SecureTransport": "false"
            Principal: "*"